<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>알림 설정</title>
    <link rel="stylesheet" href="/css/user/notification.css">
</head>
<body>
<h1>알림</h1>

<div class="tab-container">
    <div class="tab active" data-tab="all">전체</div>
    <div class="tab" data-tab="keyword">키워드 알림</div>
    <div class="tab" data-tab="comment">댓글 알림</div>
    <div class="tab" data-tab="like">좋아요 알림</div>
</div>

<div id="all" class="tab-content active">
    <ul id="allNotificationList"></ul>
</div>

<div id="keyword" class="tab-content">
    <!-- 키워드 설정 폼 -->
    <form id="keywordForm">
        <input type="text" id="keywordInput" placeholder="키워드 입력..." required>
        <button type="submit">키워드 설정</button>
    </form>

    <!-- 등록된 키워드 표시 -->
    <div id="registeredKeyword">
        <h3>등록된 키워드:</h3>
        <ul id="keywordList"></ul>
    </div>

    <ul id="keywordNotificationList"></ul>
</div>

<div id="comment" class="tab-content">
    <h2>댓글 알림</h2>
    <p>댓글 알림 기능은 아직 구현되지 않았습니다.</p>
</div>

<div id="like" class="tab-content">
    <h2>좋아요 알림</h2>
    <p>좋아요 알림 기능은 아직 구현되지 않았습니다.</p>
</div>

<script>
    let eventSource;

    // 탭 전환 기능
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
        });
    });

    // SSE 연결, 이벤트 수신
    function connectSSE() {
        eventSource = new EventSource('/notifications/stream');

        eventSource.onopen = function(event) {
            console.log("SSE connection opened");
        };

        eventSource.onerror = function(event) {
            console.error("SSE connection error:", event);
            eventSource.close();
            setTimeout(connectSSE, 5000); // 연결 오류 시 5초 후 재연결 시도
        };

        // 서버로부터 'notification' 이벤트를 수신했을 때 호출
        eventSource.addEventListener('notification', function(event) {
            console.log("Received notification:", event.data);
            addNotificationToList(event.data);
        });

        eventSource.addEventListener('connect', function(event) {
            console.log("SSE connected:", event.data);
        });
    }

    // 수신한 알림을 알림 목록에 추가
    function addNotificationToList(message) {
        const listItem = document.createElement('li');
        listItem.textContent = message;
        document.getElementById('allNotificationList').insertBefore(listItem, document.getElementById('allNotificationList').firstChild);
        document.getElementById('keywordNotificationList').insertBefore(listItem.cloneNode(true), document.getElementById('keywordNotificationList').firstChild);
    }

    // 사용자가 설정한 키워드를 화면에 표시
    function loadKeywords() {
        fetch('/notifications/current-keywords')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(keywords => {
                console.log("Keywords loaded:", keywords);
                const keywordList = document.getElementById('keywordList');
                keywordList.innerHTML = '';
                keywords.forEach(keyword => {
                    const li = document.createElement('li');
                    li.textContent = keyword;
                    const removeButton = document.createElement('button');
                    removeButton.textContent = '삭제';
                    removeButton.onclick = () => removeKeyword(keyword);
                    li.appendChild(removeButton);
                    keywordList.appendChild(li);
                });
            })
            .catch(error => console.error('Error loading keywords:', error));
    }

    // 특정 키워드를 삭제
    function removeKeyword(keyword) {
        console.log(`Removing keyword: ${keyword}`);
        fetch(`/notifications/keyword?keyword=${encodeURIComponent(keyword)}`, {
            method: 'DELETE'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(result => {
                console.log("Keyword removed:", result);
                alert(result);
                loadKeywords();
            })
            .catch(error => console.error('Error removing keyword:', error));
    }

    document.getElementById('keywordForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const keyword = document.getElementById('keywordInput').value;
        console.log(`Setting keyword: ${keyword}`);

        fetch('/notifications/keyword', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `keyword=${encodeURIComponent(keyword)}`
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(result => {
                console.log("Keyword set:", result);
                alert(result);
                loadKeywords();
                document.getElementById('keywordInput').value = '';
            })
            .catch(error => console.error('Error setting keyword:', error));
    });

    function loadExistingNotifications() {
        console.log("Loading existing notifications...");
        fetch('/notifications/unread')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(notifications => {
                console.log("Existing notifications loaded:", notifications);
                notifications.forEach(notification => {
                    addNotificationToList(notification.message);
                });
            })
            .catch(error => console.error('Error loading notifications:', error));
    }

    window.addEventListener('load', function() {
        console.log("Page loaded, initializing...");
        loadKeywords();
        loadExistingNotifications();
        connectSSE();
    });
</script>
</body>
</html>